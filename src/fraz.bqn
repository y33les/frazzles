curl â† â€¢Import "../lib/bqn-curl/curl.bqn"
read â† â€¢Import "read.bqn"
err â† â€¢Import "err.bqn"
msg â† â€¢Import "msg.bqn"
str â† â€¢Import "str.bqn"
config â† â€¢Import "config.bqn"

cmdSet â‡ âŸ¨"new","add","remove","search","help"âŸ© # Allowed commands
cmdHelpMap â† cmdSet â€¢HashMap âŸ¨msg.help.new,msg.help.add,msg.help.remove,msg.help.search,msg.help.helpâŸ© # Allowed commands with their corresponding help messages
frazIndex â† "get.frazzl.es" # Default Frazzle index

New â‡ {
  (1=â‰ ğ•©) err._Assert_ msg.use.new
  dir â† â€¢wdpath â€¢file.At âŠ‘ğ•©
  (Â¬â€¢file.Exists dir) err._Assert_ ("Directory "âˆ¾dirâˆ¾" already exists.")
  â€¢file.CreateDir dir
  (dir â€¢file.At ".frazzle") config.Write confâ†config.Generate config.Input ""
  â€¢file.CreateDirÂ¨ dirâŠ¸â€¢file.AtÂ¨ "src"â€¿"lib"â€¿"test"
  (dir â€¢file.At "LICENSE") â€¢file.Lines âŸ¨âˆ¾Â´"<placeholder: "âˆ¾(conf.Get "license")âˆ¾">"âŸ©
  (dir â€¢file.At "README.md") â€¢file.Lines âŸ¨âˆ¾Â´"# "âˆ¾conf.Get "name","",conf.Get "description"âŸ©
  (dir â€¢file.At "src" â€¢file.At (conf.Get "name")âˆ¾".bqn") â€¢file.Lines âŸ¨"Hello â‡ {","  â€¢Out âˆ¾Â´""Hello, ""âˆ¾ğ•©âˆ¾""!""","}"âŸ©
  (dir â€¢file.At "main.bqn") â€¢file.Lines âŸ¨âˆ¾Â´(conf.Get "name")âˆ¾" â† â€¢Import ""src/"âˆ¾(conf.Get "name")âˆ¾".bqn""","",âˆ¾Â´(conf.Get "name")âˆ¾".Hello ""world"""âŸ©
  (dir â€¢file.At "test" â€¢file.At "all.bqn") â€¢file.Lines âŸ¨"â€¢Out ""Hello, world!"""âŸ©
  â€¢Out "New Frazzle created in "âˆ¾dirâˆ¾"."
}

Add â‡ {
  (0â‰ â‰ ğ•©) err._Assert_ msg.use.add
  (â€¢file.Exists â€¢wdpath â€¢file.At ".frazzle") err._Assert_ "This command must be run from the root directory of a Frazzle."
  offset â† 0
  {"-i"â‰¡âŠ‘ğ•© ? (2<â‰ ğ•©) err._Assert_ msg.use.search â‹„ frazIndex â†© 1âŠ‘ğ•© â‹„ offsetâ†©2 ; (1=â‰ ğ•©) err._Assert_ msg.use.search}ğ•©
  search â† offsetâ†“ğ•©
  â€¢Show search
  Download â† {
    response â† curl.Get url â† âˆ¾Â´"ftp://"âˆ¾frazIndexâˆ¾"/"âˆ¾ğ•©âˆ¾".frz" # TODO: add check to make sure no protocol:// header
    â€¢Show url
    (226=response.code) err._Assert_ ("Failed to fetch Frazzle index with code "âˆ¾(â€¢Fmt response.code)âˆ¾" ("âˆ¾urlâˆ¾").") # 226 is FTP OK
    libdir â† â€¢wdpath â€¢file.At "lib"
    outfile â† libdir â€¢file.At "._frz_"âˆ¾ğ•©
    â€¢Show outfile
    outfile â€¢file.Bytes response.content
    â€¢SH "tar"â€¿"xJf"â€¿outfile # TODO: A pure BQN (or even an â€¢FFI) solution would be nicer here at some point
    â€¢file.Remove outfile
  }
  DownloadÂ¨ search # TODO: test!!
}

Remove â‡ { â€¢ShowâŒ½Â¨ğ•© }

SearchFrazzle â† { # TODO: Make it able to search descriptions as well, once I've figured out how to store and provide them
  (0â‰ â‰ ğ•©) err._Assert_ msg.use.search
  offset â† 0 # Where the search term is (in case -i is used)
  {"-i"â‰¡âŠ‘ğ•© ? (3=â‰ ğ•©) err._Assert_ msg.use.search â‹„ frazIndex â†© 1âŠ‘ğ•© â‹„ offsetâ†©2 ; (1=â‰ ğ•©) err._Assert_ msg.use.search}ğ•©
  search â† offsetâŠ‘ğ•©
  response â† curl.Get "ftp://"âˆ¾frazIndex # TODO: add check to make sure no protocol:// header
  (226=response.code) err._Assert_ ("Failed to fetch Frazzle index with code "âˆ¾(â€¢Fmt response.code)âˆ¾".") # 226 is FTP OK
  files â† str.lf str.Split response.content
  files {âŠ‘âŒ½' ' str.Split ğ•©}Â¨â†©
  frazzles â† ".frz" str.SearchList files
  results â† search str.SearchList Â¯4â†“Â¨frazzles
}
GetDescription â† {
  # TODO: input checks
  response â† curl.Get âˆ¾Â´"dict://"âˆ¾ğ•¨âˆ¾"/d:"âˆ¾ğ•© # TODO: add check to make sure no protocol:// header
  response â†© str.lfâŠ¸str.CutÂ¨ str.cr str.Cut response.content
  (552â‰ str.ParseInt 3â†‘âŠ‘2âŠ‘response) err._Assert_ (âˆ¾Â´"There is no Frazzle named '"âˆ¾ğ•©âˆ¾"' at "âˆ¾ğ•¨âˆ¾".") # 552 is the DICT code for no entries found
  result â† âŠ‘4âŠ‘response
}
Search â‡ { â€¢OutÂ¨ frazIndexâŠ¸GetDescriptionÂ¨ SearchFrazzle ğ•© }

Help â‡ {
  (2>â‰ ğ•©) err._Assert_ msg.use.help
  { 0=â‰ ğ•© ? â€¢Out msg.help.fraz â‹„ â€¢Exit 0 ; @ }ğ•© # Display toplevel help message if no command provided
  (âˆŠâŸœcmdSetâŒ¾<âŠ‘ğ•©) err._Assert_ ("Allowed commands are: "âˆ¾{ğ•¨âˆ¾", "âˆ¾ğ•©}Â´cmdSet)
  â€¢Out cmdHelpMap.Get âŠ‘ğ•© 
}

# TODO: Test
# TODO: Build
# TODO: Run (not for libs) (run folder and run .frz file)
# TODO: Publish?