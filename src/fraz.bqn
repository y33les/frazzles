âŸ¨ Get, Post âŸ© â† â€¢Import "../lib/bqn-curl/curl.bqn"
âŸ¨ read âŸ© â† â€¢Import "read.bqn"

fraz â‡ {
  r â† Get "https://httpbin.org/get"
  Test â‡ { ğ•©âˆ¾r.code }
}

cmdSet â† âŸ¨"new","init","add","remove","search","help"âŸ© # Allowed commands

# Fail prettily (users don't need a stack trace) with message ğ•¨ and ignore ğ•©
# TODO: spin this out into another namespace
Fail â† { â€¢Out ğ•¨ â‹„ â€¢Exit Â¯1}
_Assert_ â† { !âŠ(ğ•˜âŠ¸fail) ğ•— }

# Various help strings # TODO: spin out into another file/namespace
helpMsg â† "Usage: fraz [new|init|add|remove|search|help] <args>

   new: Create a new Frazzle in a given directory
  init: Initialise a new Frazzle in the current directory (or another directory, if given)
   add: Add one or more Frazzles to lib/ in the current directory
remove: Remove one or more Frazzles from lib/ in the current directory
search: Query available Frazzles on frazzl.es (or $FRAZZLES_INDEX, if defined)
  help: Display this message, or get specific help with a given command

You can also call 'fraz help <command> for more in-depth help with a specific command."
newHelpMsg â† "TODO: new help message" # TODO
initHelpMsg â† "TODO: init help message" # TODO
addHelpMsg â† "TODO: add help message" # TODO
removeHelpMsg â† "TODO: remove help message" # TODO
searchHelpMsg â† "TODO: search help message" # TODO
helpHelpMsg â† "You think you're funny, don't you?"
cmdHelpMap â† cmdSet â€¢HashMap âŸ¨newHelpMsg,initHelpMsg,addHelpMsg,removeHelpMsg,searchHelpMsg,helpHelpMsgâŸ© # Allowed commands with their corresponding help messages

# Process arguments: fraz <cmd> <args>
args â† â€¢args
{ 0=â‰ ğ•© ? â€¢Out helpMsg â‹„ â€¢Exit 0 ; @ }args # Display help message if no arguments provided
cmd â† âŠ‘args
(âˆŠâŸœcmdSetâŒ¾<cmd) _Assert_ ("Allowed commands are: "âˆ¾{ğ•¨âˆ¾", "âˆ¾ğ•©}Â´cmdSet) # Fail if cmd is unknown
args 1âŠ¸â†“â†©

configHeaders â† âŸ¨"name","description","author","version","type","licence","dependencies"âŸ©
# Generate a config HashMap where ğ•© is a list of corresponding to the Frazzle name (string), description (string), author (string), version (string), type (string: "app" or "lib") licence (string) and dependencies (list of strings).
# TODO: Implement dependency versioning like in Python (e.g. "numpy==1.1.14")
InputConfig â† {
  â€¢Out "Frazzle name:"
  name â† read.LineNoBlank ""
  â€¢Out "Description:"
  description â† read.LineNoBlank ""
  â€¢Out "Author:"
  author â† read.LineNoBlank ""
  â€¢Out "Version number:"
  version â† read.LineNoBlank ""
  â€¢Out "Frazzle type ('app' or 'lib'):"
  type â† read.LineNoBlank ""
  â€¢Out "Licence:"
  licence â† read.LineNoBlank ""
  dependencies â† ""
  âŸ¨name,description,author,version,type,licence,dependenciesâŸ©
}
GenConfig â† {
  "GenConfig requires a list of length 7."!7=â‰ ğ•©
  configHeaders â€¢HashMap ğ•©
}
ReadConfig â† { ğ•© }
WriteConfig â† { ğ•© â€¢file.Chars helpMsg } # TODO: Replace placeholder

New â† {
  (1=â‰ ğ•©) _Assert_ "Usage: fraz new <dir>"
  dir â† â€¢wdpath â€¢file.At âŠ‘ğ•©
  (Â¬â€¢file.Exists dir) _Assert_ ("Directory "âˆ¾dirâˆ¾" already exists.")
  â€¢file.CreateDir dir
  frazFile â† dir â€¢file.At ".frazzle"
  WriteConfig frazFile # TODO: GenConfig + WriteConfig
  â€¢Out "New Frazzle created in "âˆ¾dirâˆ¾"."
}
Init â† {
  (0=â‰ ğ•©) _Assert_ "fraz init does not accept arguments.  Did you mean 'fraz new <dir>'?"
  frazFile â† â€¢wdpath â€¢file.At ".frazzle"
  (Â¬â€¢file.Exists frazFile) _Assert_ "This directory is already a Frazzle."
  WriteConfig frazFile
  â€¢Out "Frazzle initialised in "âˆ¾â€¢wdpath
}
Add â† { â€¢ShowâŒ½ğ•© }
Remove â† { â€¢ShowâŒ½Â¨ğ•© }
Search â† {
  usageMsg â† "Usage: fraz search [-i <Frazzle index URL>] <search term>"
  frazIndex â† "ftp://ftp.frazzl.es"
  (0â‰ â‰ ğ•©) _Assert_ usageMsg
  {"-i"â‰¡âŠ‘ğ•© ? usageMsg!2=â‰ ğ•© â‹„ frazIndex â†© 1âŠ‘ğ•© ; usageMsg!1=â‰ ğ•©}ğ•©
  â€¢Out frazIndex
}
Help â† {
  (2>â‰ ğ•©) _Assert_ "Usage: fraz help [command]"
  { 0=â‰ ğ•© ? â€¢Out helpMsg â‹„ â€¢Exit 0 ; @ }ğ•© # Display toplevel help message if no command provided
  (âˆŠâŸœcmdSetâŒ¾<cmd) _Assert_ ("Allowed commands are: "âˆ¾{ğ•¨âˆ¾", "âˆ¾ğ•©}Â´cmdSet)
  â€¢Out cmdHelpMap.Get âŠ‘ğ•© 
}
cmdFnMap â† cmdSet â€¢HashMap âŸ¨new,init,add,remove,search,helpâŸ© # Allowed commands with their corresponding functions

# Run it!
args{ğ•ğ•¨}cmdFnMap.Get cmd